---
title: "Hepatocarcinoma Multi-Omics Differential Analysis"
author: "Robert M Flight"
date: last-modified
date-format: YYYY-MM-DD HH:mm
format: 
  html:
    embed-resources: true
    toc: true
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = FALSE,
											message = FALSE,
											dev = "ragg_png",
											dpi = 300)
targets::tar_source("./packages.R")
tar_source("R")
library(tidygraph)
library(ggraph)
library(dbscan)
```

```{r}
#| label: load-targets
#| include: false
tar_load(c(rna_de_patient,
					 metabolomics_de_patient_list,
					 rna_metabolites_all_spearman,
					 rna_within_cor,
					 metabolites_within_cor,
					 feature_lipid,
					 feature_kegg,
					 metabolite_type_annotations,
					 feature_to_kegg_chebi,
					 metabolomics_enrichment_lipid_binomial,
					 metabolomics_enrichment_reactome_binomial
					 ))
```

## Data

Hepatocarcinoma transcriptomics significant entries, and metabolomics significant entries (p-adjusted <= 0.05), Spearman correlated between the genes and metabolites, using the 12 samples that are in common across all 4 datasets.

## Methods

Correlations of all metabolites were calculated with all of the genes, using Spearman correlation method, with zero representing a missing value.

Hypergeometric enrichment tests if a particular annotation is represented more in a group (i.e. significant entries) than expected by chance compared to the presence among all those measured.
Binomial enrichment tests if the ratio of positive and negative fold-changes for a group of annotated features differs significantly from an expected ratio (generally 0.5).
The advantage of binomial enrichment is that it uses **all** of the annotated features, instead of comparing significant to all.
Binomial enrichment of metabolites were calculated based on both reactome pathways and lipid annotations of lipid class, total and individual chain length, total and individual number of unsaturations, as well as their combinations.
For significant binomial enrichments of metabolites (p-adjusted < 0.1 for lipids or 0.05 for pathways), genes with significant correlation to the group of metabolites were extracted, and then binomial enrichment of the genes with significant correlation calculated, as well as for those genes annotated to GO terms.
Binomial enrichment was restricted to those annotations with six or more features annotated to it.

## Named Metabolites?

How many metabolites actually have any kind of useable name or identifier in the full dataset, and in the significant metabolites?
We show this in @tbl-named-metabolite-locs.

```{r}
#| label: tbl-named-metabolite-locs
#| tbl-cap: Number of named and unknown metabolites by overall metabolite class and direction, for all and significant metabolites. *has_name* indicates whether the metabolite is named or unknown; *lfc_direction* indicates what direction the log-fold-change was; *n_entry.all* is how many metabolites were present across all metabolites; *perc_entry.all* is what percentage of metabolites across all metabolites; *n_entry.sig* is how many were present in the significant set; *perc_entry.sig* is what percentage of the significant set.
metabolites_significant = metabolomics_de_patient_list |>
	dplyr::mutate(has_name = dplyr::case_when(
		!is.na(in_chi_key) ~ "named",
		is.na(in_chi_key) ~ "unknown"
	),
	lfc_direction = dplyr::case_when(
		log2FoldChange > 0 ~ "Positive",
		log2FoldChange < 0 ~ "Negative"
	))
summary_names = metabolites_significant |>
	dplyr::group_by(type, has_name, lfc_direction) |>
	dplyr::summarise(n_entry.all = dplyr::n()) |>
	dplyr::ungroup() |>
	dplyr::mutate(perc_entry.all = n_entry.all / sum(n_entry.all))
summary_sig = metabolites_significant |>
	dplyr::filter(padj <= 0.05) |>
	dplyr::group_by(type, has_name, lfc_direction) |>
	dplyr::summarise(n_entry.sig = dplyr::n()) |>
	dplyr::ungroup() |>
	dplyr::mutate(perc_entry.sig = n_entry.sig / sum(n_entry.sig))

summary_all = dplyr::bind_cols(summary_names[, c("type", "has_name", "lfc_direction", 
																								 "n_entry.all", "perc_entry.all")],
															 summary_sig[, c("n_entry.sig", "perc_entry.sig")])
summary_all |>
	dplyr::group_by(type) |>
gt::gt() |>
	gt::fmt_percent(c(perc_entry.all, perc_entry.sig), decimals = 0)
```

Concentrating on those **bioamines**, how many of the named ones are annotated to a pathway?
These are shown in @tbl-bioamines-pathway.

```{r}
#| label: tbl-bioamines-pathway
#| tbl-cap: Number of bioamines that are named, can be mapped to a KEGG compound, and then to a KEGG pathway.
bioamines_sig = metabolites_significant |>
	dplyr::filter(padj <= 0.05, type %in% "bioamines") |>
	dplyr::select(feature_id, metabolite_id, in_chi_key, log2FoldChange)
bioamines_sig_merge = dplyr::left_join(bioamines_sig, feature_to_kegg_chebi[, -2],
																			 by = "feature_id")
all_kegg_annotated = unique(unlist(feature_kegg@annotation_features))

bioamines_sig_merge = bioamines_sig_merge |>
	dplyr::mutate(pathway = dplyr::case_when(
		feature_id %in% all_kegg_annotated ~ "in_pathway",
		TRUE ~ "unknown"
	),
	kegg = dplyr::case_when(
		!is.na(kegg) ~ "in_kegg",
		TRUE ~ "unknown"
	),
	lfc_direction = dplyr::case_when(
		log2FoldChange > 0 ~ "Positive",
		log2FoldChange < 0 ~ "Negative"
	))

bioamines_kegg_n = bioamines_sig_merge |>
	dplyr::group_by(lfc_direction, kegg, pathway) |>
	dplyr::summarise(n_compound = dplyr::n()) |>
	dplyr::ungroup()
gt::gt(bioamines_kegg_n)
```

This becomes really, really important, because we wanted to initially restrict the correlative analysis to the significant genes and significant metabolites.
However, because there are so few named metabolites in the significant set, we don't see anything in the enrichment results that appears useful.

## Significant Correlations

P-adjusted correlations <= 0.01.
@fig-examine-correlations shows the histogram of significant correlations between all genes and metabolites.

@tbl-n-genes-metabolites lists how many metabolites and genes are in the significant correlations.

```{r}
#| label: fig-examine-correlations
#| fig-cap: Number of genes and metabolites having significant correlations.
sig_cor = rna_metabolites_all_spearman |>
	dplyr::filter(padjust <= 0.01) |>
	dplyr::transmute(gene = s1, metabolite = s2, cor = cor,
									 dir = sign(cor))

rna_sig = rna_de_patient |>
	dplyr::transmute(gene.lfc = sign(log2FoldChange),
									 gene = feature_id)
met_sig = metabolomics_de_patient_list |>
	dplyr::transmute(metabolite.lfc = sign(log2FoldChange),
									 metabolite = feature_id)
sig_cor = dplyr::left_join(sig_cor, rna_sig, by = "gene")
sig_cor = dplyr::left_join(sig_cor, met_sig, by = "metabolite")
sig_cor |>
	ggplot(aes(x = cor)) +
	geom_histogram(bins = 100)
```

```{r}
#| label: tbl-n-genes-metabolites
#| tbl-cap: Number of genes and metabolites after filtering to those with significant correlations (p-adjust <= 0.01).
n_each = sig_cor |>
	dplyr::summarise(n_gene = length(unique(gene)),
									 n_metabolite = length(unique(metabolite)))
gt::gt(n_each)
```

```{r}
#| label: fig-n-to-each
#| fig-cap: Histograms of number of metabolites with significant edges to genes (Genes -> Metabolites) and number of genes with significant edges to metabolites (Metabolites -> Genes), split out by direction of correlation and direction of log-fold-change of the first entry.
#| fig-width: 8
#| fig-height: 15
gene_to_metabolite = sig_cor |>
	dplyr::mutate(sign = sign(cor)) |>
	dplyr::group_by(gene, sign, gene.lfc) |>
	dplyr::summarise(g2m = dplyr::n())
metabolite_to_gene = sig_cor |>
	dplyr::mutate(sign = sign(cor)) |>
	dplyr::group_by(metabolite, sign, metabolite.lfc) |>
	dplyr::summarise(m2g = dplyr::n())

gm_plot = gene_to_metabolite |>
	dplyr::mutate(gene.lfc = paste0("lfc ", gene.lfc),
								sign = paste0("cor ", sign)) |>
	ggplot(aes(x = g2m)) +
	geom_histogram(bins = 100) +
	facet_grid(gene.lfc ~ sign) +
	labs(subtitle = "Genes -> Metabolites")
mg_plot = metabolite_to_gene |>
	dplyr::mutate(metabolite.lfc = paste0("lfc ", metabolite.lfc),
								sign = paste0("cor ", sign)) |>
	ggplot(aes(x = m2g)) +
	geom_histogram(bins = 100) +
	facet_grid(metabolite.lfc ~ sign) +
	labs(subtitle = "Metabolites -> Genes")
gm_plot / mg_plot
```


We can consider this as a simple bipartite graph, and order the nodes by their number of edges and type, as shown in @fig-sig-cor-graph.
We can also ignore the type of node, and just order them by whether the gene or metabolite had positive or negative LFC and the number of edges to the other type of node, see @fig-sig-cor-graph2.
Both of these imply there are definite groups of metabolites all connected to one or more sets of genes.

```{r}
#| label: fig-sig-cor-graph
#| fig-cap: Bipartite graphing of connected genes and metabolites, ordered by node type (gene or metabolite) and number of nodes.
#| fig-width: 9
#| fig-height: 8

all_lfc = dplyr::bind_rows(rna_sig |>
													 	dplyr::transmute(name = gene,
													 									 lfc = gene.lfc),
													 met_sig |>
													 	dplyr::transmute(name = metabolite,
													 									 lfc = metabolite.lfc))

sig_cor_graph = as_tbl_graph(sig_cor, directed = FALSE) |>
	dplyr::mutate(type = dplyr::case_when(
		grepl("^ENS", name) ~ "gene",
		TRUE ~ "metabolite"
	),
	n_connect = tidygraph::centrality_degree())

sig_cor_graph = dplyr::left_join(sig_cor_graph, all_lfc, by = "name")

sig_cor_graph = sig_cor_graph |>
	arrange(type, n_connect)

ggraph(sig_cor_graph, layout = "linear", circular = TRUE) +
	geom_edge_arc(alpha = 0.01) +
	geom_node_point(aes(color = type)) +
	coord_fixed()
```



```{r}
#| label: fig-sig-cor-graph2
#| fig-cap: Ordered by up or down log-fold-change, and number of connections. Color of nodes indicate gene or metabolite, and color of edge is positive or negative correlation.
#| fig-width: 9
#| fig-height: 8
sig_cor_graph = sig_cor_graph |>
	arrange(lfc, n_connect)
ggraph(sig_cor_graph, layout = "linear", circular = TRUE) +
	geom_edge_arc(alpha = 0.01, aes(color = dir)) +
	geom_node_point(size = 0.5, aes(color = type)) +
	coord_fixed()
```

That is a lot of correlations to try and follow up on!

## Binomial Enriched Metabolites

To find potentially **interesting** metabolite to gene correlations, we will use binomial enrichment of the metabolite pathways (@tbl-metabolite-binomial-compounds) and lipid annotations (@tbl-metabolite-binomial-lipids) (see Methods).

```{r}
#| label: tbl-metabolite-binomial-compounds
#| tbl-cap: Binomial enrichments for compound reactome pathway annotations, for those annotations with an adjusted p-value <= 0.05.
compound_enrich_table = metabolomics_enrichment_reactome_binomial$stats |>
	dplyr::arrange(padjust) |>
	dplyr::filter(padjust <= 0.05) |>
	dplyr::select(description, num_positive, num_negative, p, padjust) |>
	gt::gt() |>
	gt::fmt_integer(columns = c(num_positive, num_negative)) |>
	gt::fmt_number(columns = c(p, padjust), n_sigfig = 2)
compound_enrich_table	
```

```{r}
#| label: tbl-metabolite-binomial-lipids
#| tbl-cap: Binomial enrichments for lipid annotations, for those annotations with an adjusted p-value <= 0.1.
lipid_enrich_table = metabolomics_enrichment_lipid_binomial$stats |>
	dplyr::arrange(padjust) |>
	dplyr::filter(padjust <= 0.1) |>
	dplyr::select(id, num_positive, num_negative, p, padjust) |>
	gt::gt() |>
	gt::fmt_number(columns = c(p, padjust), n_sigfig = 2)
lipid_enrich_table
```

